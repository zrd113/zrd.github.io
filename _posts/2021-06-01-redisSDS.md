---
layout: post
title: redis-简单动态字符串
date: 2021-06-01
Author: zrd
tags: [redis]
toc: true
---

## 一、 SDS的定义

```
struct sdshdr{
    //记录buf数组未使用的字节数量
    int free;
    //记录buf数组已使用的字节数量，不包括最后的空字符
    int len;
    //用于保存字符串
    char buf[];
}
```

## 二、 SDS与c字符串的区别

### 1. 以常数复杂度获取字符串长度

c字符串不记录自身的长度信息，所以为了获取长度，必须遍历整个字符串，时间复杂度为O(n); SDS在len属性中记录了字符串的长度，获取的时间复杂度为O(1)。

### 2. 防止缓冲区溢出

当修改c字符串时，如果忘记给字符串分配足够的空间就有可能导致缓冲区溢出，使得另一个字符串被修改。SDS的空间分配策略则杜绝这种可能性，因为当对SDS进行修改的时候，会先检查空间是否满足需求，不满足的话会先进行扩容。

#### 2.1 空间分配策略

在c语言中，每次修改字符串时都要进行扩容或释放内存，否则就会造成缓冲区溢出或者内存泄漏，但是内存重分配是一个比较耗时的操作，对于redis这种需要频繁修改的数据库来说是不可接受的，所以SDS使用了空间预分配和惰性空间释放这两种优化策略。
    a. 空间预分配
       当对空间进行扩展时，不仅会分配所必须的空间，还会分配额外的未使用空间。若修改后len小于1M，则会分配
       同样大小的free空间，若修改后长度大于等于1M，那么会给free分配1M的长度。
    b. 惰性空间释放
       当对空间进行缩短时，不会立即释放内存，而是通过free记录起来等待以后使用。

### 3. 二进制安全

在c字符串末尾必须以空字符结尾，中间不能包含空字符，否则就会被误认为字符串结尾，这种限制使得c字符串只能保存文本数据，而在SDS中还可以保存视频、图片等二进制数据，因为它是通过len属性来判断字符串是否结束而不是空字符。

