---
layout: post
title: redis-压缩列表
date: 2021-06-06
Author: zrd
tags: [redis]
toc: true
---

压缩列表是列表键和哈希键的底层实现之一。当一个列表键只包含少量列表项，并且每个列表项要么就是小整数值，要么就是长度比较短的字符串，那么Redis就会使用压缩列表来做列表键的底层实现。

## 一、 压缩列表的定义

压缩列表是为了节约内存而开发的，是由一系列特殊编码的连续内存块组成的顺序型数据结构。一个压缩列表可以包含任意多个节点，每个节点可以保存一个字节数组或者一个整数值，类似于数组。

![压缩列表结构](/images/redisZipList.png)

1. zlbytes：类型：uint32_t，长度：4byte，用途：记录整个压缩列表占用的内存字节数:在对压缩列表进行内存重分配,或者计算zlend的位置时使用。
2. zltail：类型:uint32_t，长度:4byte，用途：记录压缩列表表尾节点距离压缩列表的起始地址有多少字节:通过这个偏移量,程序无须遍历整个压缩列表就可以确定表尾节点的地址。
3. zllen：类型：uint16_t，长度：2byte，用途：记录了压缩列表包含的节点数量，当这个属性的值小于UlNT16_MAX(65535)时，这个属性的值就是压缩列表包含节点的数量；当这个值等于UINT16_MAX时，节点的真实数量需要历整个压缩列表才能计算得出。
4. entry：类型：列表节点，长度：不定，用途：压缩列表包含的各个节点，节点的长度由节点保存的内容决定。
5. zlend：类型：uint8_t，长度：1 byte，用途:特殊值0xFF(十进制255)，用于标记压缩列表的末端。

## 二、 压缩列表节点的构成

![压缩列表节点的构成](/images/redisZipListNode.png)

节点的 previous_entry_length属性以字节为单位,记录了压缩列表中前一个节点的长度。previous_entry_length属性的长度可以是1字节或者5字节。
    1. 如果前一节点的长度小于254字节,那么 previous_entry_length属性的长度为1字节，前一节点的长度就保存在这一个字节里面。
    2. 如果前一节点的长度大于等于254字节,那么 previous_entry_length属性的长度为5字节:其中属性的第一字节会被设置为0xFE(十进制值254),而之后的四个字节则用于保存前一节点的长度.

节点的encoding属性记录了节点的content属性所保存数据的类型以及长度。
    1. 一字节、两字节或者五字节长,值的最高位为00、01或者10的是字节数组编码这种编码表示节点的 content属性保存着字节数组,数组的长度由编码除去最高两位之后的其他位记录。
    2. 一字节长,值的最高位以11开头的是整数编码:这种编码表示节点的content属性保存着整数值,整数值的类型和长度由编码除去最高两位之后的其他位记录。

节点的content属性负责保存节点的值,节点值可以是一个字节数组或者整数,值的类型和长度由节点的encoding属性决定。



